name: Deploy Edge Functions to Production

# This workflow automatically deploys edge functions to production
# when changes are merged to the main branch (via PR merge or direct push)
on:
  push:
    branches:
      - main
    paths:
      - "supabase/functions/**" # Only trigger when Edge Functions change

jobs:
  deploy-edge-functions:
    runs-on: ubuntu-latest
    environment: production # Explicitly mark as production deployment

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Install Supabase CLI
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3Ô∏è‚É£ Verify secrets exist
      - name: Verify secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_PROJECT_ID }}" ] || [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "‚ùå Missing Supabase secrets. Ensure SUPABASE_PROJECT_ID & SUPABASE_ACCESS_TOKEN are set."
            exit 1
          fi
          echo "‚úÖ All required secrets are present"

      # 4Ô∏è‚É£ Deploy Edge Functions to Production
      - name: Deploy Edge Functions to Production
        run: |
          echo "üöÄ Deploying all edge functions to production..."
          supabase functions deploy --all --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
          echo "‚úÖ Edge functions deployed successfully"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # 5Ô∏è‚É£ Verify deployment
      - name: List deployed functions
        run: |
          echo "üìã Listing deployed functions..."
          supabase functions list --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # 6Ô∏è‚É£ Deployment notification
      - name: Deployment complete
        run: |
          echo "‚úÖ Edge functions successfully deployed to production"
          echo "Project: ${{ secrets.SUPABASE_PROJECT_ID }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

